(function(){"use strict";BX.namespace("BX.Landing");var n=BX.Landing.Utils.isPlainObject;var a=BX.Landing.Utils.isString;BX.Landing.Backend=function(){this.ajaxController="/bitrix/tools/landing/ajax.php"};BX.Landing.Backend.instance=null;BX.Landing.Backend.getInstance=function(){if(!BX.Landing.Backend.instance){BX.Landing.Backend.instance=new BX.Landing.Backend}return BX.Landing.Backend.instance};BX.Landing.Backend.prototype={action:function(n,t,i,e){e=BX.type.isPlainObject(e)?e:{};i=BX.type.isPlainObject(i)?i:{};BX.Landing.Utils.assign(i,{site_id:this.getSiteId()});var c={};c.sessid=BX.bitrix_sessid();c.action=n.replace("Landing\\Block","Block");c.data=typeof t==="object"?t:{};c.data.lid=c.data.lid||BX.Landing.Main.getInstance().id;if("action"in e){c.action=e.action}if("block"in e){c.data.block=e.block}if("lid"in e){c.data.lid=e.lid}if("id"in e){c.data.id=e.id}var o=BX.util.add_url_param(this.ajaxController,BX.util.objectMerge({action:c.action},i));return new Promise(function(n,a){BX.ajax({method:"POST",dataType:"json",url:o,data:c,onsuccess:function(t){if(!!t&&t.type==="error"){a(t)}else{n(t.result)}},onfailure:function(n){a(n)}})}).then(function(n){if(c.action==="Block::updateNodes"||c.action==="Block::removeCard"||c.action==="Block::cloneCard"||c.action==="Block::addCard"){BX.Landing.UI.Panel.StatusPanel.getInstance().update()}return n}).catch(function(n){if(c.action!=="Block::getById"){n=a(n)?{type:"error"}:n;n.action=c.action;BX.Landing.ErrorManager.getInstance().add(n)}return Promise.reject()})},batch:function(n,t,i){i=BX.type.isPlainObject(i)?i:{};BX.Landing.Utils.assign(i,{site_id:t.siteId||this.getSiteId()});var e={};e.sessid=BX.bitrix_sessid();e.action=n.replace("Landing\\Block","Block");e.data={};e.batch=typeof t==="object"?t:{};e.data.lid=e.data.lid||BX.Landing.Main.getInstance().id;var c=BX.util.add_url_param(this.ajaxController,BX.util.objectMerge({action:e.action},i));return new Promise(function(n,a){BX.ajax({method:"POST",dataType:"json",url:c,data:e,onsuccess:function(t){if(!!t&&t.type==="error"){a(t)}else{n(t)}},onfailure:function(n){a(n)}})}).then(function(n){BX.Landing.UI.Panel.StatusPanel.getInstance().update();return n}).catch(function(n){if(e.action!=="Block::getById"){n=a(n)?{type:"error"}:n;n.action=e.action;BX.Landing.ErrorManager.getInstance().add(n)}return Promise.reject()})},getSiteId:function(){var n;try{n=BX.Landing.Main.getInstance().options.site_id}catch(a){n=-1}return n},uploadImage:function(t,i,e,c){c=n(c)?c:{};var o={};o.sessid=BX.bitrix_sessid();o.action="action"in c?c.action:"Utils::uploadFile";o.picture=i;o.data={};o.data.params=typeof e==="object"?e:{};if("block"in c){o.data.block=c.block}if("lid"in c){o.data.lid=c.lid}if("id"in c){o.data.id=c.id}var d=BX.util.add_url_param(this.ajaxController,{action:o.action,site_id:this.getSiteId()});return new Promise(function(n,a){BX.ajax.submitAjax(t,{url:d,method:"POST",dataType:"json",data:o,onsuccess:function(t){if(!!t&&t.type==="error"){a(t)}else{n(t.result)}},onfailure:function(n){a(n)}})}).catch(function(n){n=a(n)?{type:"error"}:n;n.action=o.action;BX.Landing.ErrorManager.getInstance().add(n);return Promise.reject()})}}})();