(function(){"use strict";BX.namespace("BX.Landing");var e=BX.Landing.Utils.attr;var t=BX.Landing.Utils.data;var n=BX.Landing.Utils.encodeDataValue;var i=BX.Landing.Utils.decodeDataValue;BX.Landing.Block.Node.Img=function(e){BX.Landing.Block.Node.apply(this,arguments);this.editPanel=null;this.lastValue=null;this.field=null;this.uploadParams=e.uploadParams;if(!this.isGrouped()){this.node.addEventListener("click",this.onClick.bind(this))}if(this.isAllowInlineEdit()){this.node.setAttribute("title",BX.message("LANDING_TITLE_OF_IMAGE_NODE"))}};function a(e){return e.node.nodeName!=="IMG"}function s(e){return e.node.nodeName==="IMG"}function d(e){return e.node.nodeName==="SPAN"||e.node.nodeName==="I"||e.node.nodeName==="EM"}function o(e){var t=e.node.style.backgroundImage;t=!!t?t:"";return t.slice(4,-1).replace(/["|']/g,"")}function l(e){var t=parseInt(e.node.dataset.fileid);return t===t?t:-1}function r(t){var n=e(t.node,"alt");return!!n?n:""}function u(e){var n=t(e.node,"data-pseudo-url");return!!n?n:""}function c(t){var n=e(t.node,"src");return!!n?n:""}function h(e,t){if(!s(e)){var n=BX.create("img",{attrs:{src:t.src,alt:t.alt,"data-fileid":t.id}});e.node.parentNode.insertBefore(n,e.node);BX.remove(e.node);e.node=n}else{e.node.src=t.src;e.node.alt=t.alt;e.node.dataset.fileid=t.id||-1}}function g(e,t){if(!a(e)){var n=BX.create("div",{attrs:{style:'background-image: url("'+t.src+'")',"data-fileid":t.id}});e.node.parentNode.insertBefore(n,e.node);BX.remove(e.node);e.node=n}else{e.node.style.backgroundImage='url("'+t.src+'")';e.node.dataset.fileid=t.id||-1}}BX.Landing.Block.Node.Img.prototype={__proto__:BX.Landing.Block.Node.prototype,constructor:BX.Landing.Block.Node.Img,onClick:function(e){if(this.manifest.allowInlineEdit!==false&&BX.Landing.Main.getInstance().isControlsEnabled()&&(!BX.Landing.Block.Node.Text.currentNode||!BX.Landing.Block.Node.Text.currentNode.isEditable())&&!BX.Landing.UI.Panel.StylePanel.getInstance().isShown()){e.preventDefault();e.stopPropagation();BX.Landing.UI.Button.FontAction.hideAll();BX.Landing.UI.Button.ColorAction.hideAll();if(!this.editPanel){this.editPanel=new BX.Landing.UI.Panel.Content(this.selector,{title:BX.message("LANDING_IMAGE_PANEL_TITLE"),className:"landing-ui-panel-edit-image"});this.editPanel.appendFooterButton(new BX.Landing.UI.Button.BaseButton("save_block_content",{text:BX.message("BLOCK_SAVE"),onClick:this.save.bind(this),className:"landing-ui-button-content-save"}));this.editPanel.appendFooterButton(new BX.Landing.UI.Button.BaseButton("cancel_block_content",{text:BX.message("BLOCK_CANCEL"),onClick:this.editPanel.hide.bind(this.editPanel),className:"landing-ui-button-content-cancel"}));document.body.appendChild(this.editPanel.layout)}var t=new BX.Landing.UI.Form.BaseForm({title:this.manifest.name});t.addField(this.getField());this.editPanel.clear();this.editPanel.appendForm(t);this.editPanel.show();BX.Landing.UI.Panel.EditorPanel.getInstance().hide();BX.Landing.UI.Panel.SmallEditorPanel.getInstance().hide()}},save:function(){var e=this.editPanel.forms[0].fields[0].getValue();if(JSON.stringify(this.getValue())!==JSON.stringify(e)){this.setValue(e)}this.editPanel.hide()},getField:function(){if(!this.field){var e="";if(this.manifest.dimensions){e=BX.message("LANDING_CONTENT_IMAGE_RECOMMENDED_SIZE")+" ";e+=this.manifest.dimensions.width+"px&nbsp;/&nbsp;";e+=this.manifest.dimensions.height+"px"}var t=this.getValue();t.url=i(t.url);var n=!!this.node.closest("a");this.field=new BX.Landing.UI.Field.Image({selector:this.selector,title:this.manifest.name,description:e,disableLink:n,content:t,dimensions:!!this.manifest.dimensions?this.manifest.dimensions:{},disableAltField:a(this),uploadParams:this.uploadParams})}else{this.field.setValue(this.getValue());this.field.content=this.getValue();requestAnimationFrame(function(){this.field.adjustPreviewBackgroundSize()}.bind(this))}return this.field},setValue:function(t,n,i){this.lastValue=this.lastValue||this.getValue();this.preventSave(n);t.src=decodeURIComponent(t.src);if(s(this)){h(this,t)}if(a(this)){g(this,t)}if(t.url){e(this.node,"data-pseudo-url",t.url)}this.onChange();if(!i){BX.Landing.History.getInstance().push(new BX.Landing.History.Entry({block:this.getBlock().id,selector:this.selector,command:"editImage",undo:this.lastValue,redo:this.getValue()}))}this.lastValue=this.getValue()},getValue:function(){var e={type:"",src:"",id:-1,alt:"",url:""};if(a(this)){e.type="background";e.src=o(this);e.id=l(this)}if(s(this)){e.type="image";e.src=c(this);e.id=l(this);e.alt=r(this)}e.url=n(u(this))||{text:"",href:"",target:"_self",enabled:false};return e}}})();