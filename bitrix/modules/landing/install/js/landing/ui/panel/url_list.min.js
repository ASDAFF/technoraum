(function(){"use strict";BX.namespace("BX.Landing.UI.Panel");var t=BX.Landing.Utils.addClass;var e=BX.Landing.Utils.removeClass;var i=BX.Landing.Utils.append;var n=BX.Landing.Utils.onCustomEvent;var a=BX.Landing.Utils.fireCustomEvent;var r=BX.Landing.Utils.setTextContent;var s=BX.Landing.Utils.rect;var o=BX.Landing.Utils.create;var d=BX.Landing.Utils.style;var c=BX.Landing.Utils.join;var h=BX.Landing.Utils.isNumber;var l=BX.Landing.Utils.isString;var u=BX.Landing.Utils.isPlainObject;var g=BX.Landing.Utils.isArray;var L=BX.Landing.Cache;var f="landing";var v="block";var p="system";var I=BX.Landing.UI.Button.SidebarButton;BX.Landing.UI.Panel.URLList=function(e,a){BX.Landing.UI.Panel.Content.apply(this,arguments);t(this.layout,"landing-ui-panel-url-list");t(this.overlay,"landing-ui-panel-url-list-overlay");t(this.overlay,"landing-ui-hide");this.overlay.hidden=true;this.overlay.dataset.isShown="false";n("BX.Landing.Block:init",this.refresh.bind(this));n("BX.Landing.Block:remove",this.refresh.bind(this));i(this.layout,document.body);this.loader=new BX.Loader({target:this.content});this.promiseResolve=function(){};this.layout.hidden=true;this.isNeedLoad=true;this.cache=new L};BX.Landing.UI.Panel.URLList.getInstance=function(){if(!BX.Landing.UI.Panel.URLList.instance){BX.Landing.UI.Panel.URLList.instance=new BX.Landing.UI.Panel.URLList("url_list")}return BX.Landing.UI.Panel.URLList.instance};BX.Landing.UI.Panel.URLList.instance=null;BX.Landing.UI.Panel.URLList.prototype={constructor:BX.Landing.UI.Panel.URLList,__proto__:BX.Landing.UI.Panel.Content.prototype,refresh:function(){this.isNeedLoad=true},showLoader:function(){this.loader.show(this.content)},show:function(t,i){BX.Landing.UI.Panel.Content.prototype.show.call(this);this.clear();this.showLoader();if(t===f){e(this.layout,"landing-ui-panel-url-list-blocks");r(this.title,BX.message("LANDING_LINKS_LANDINGS_TITLE"));this.showSites(i)}else{r(this.title,BX.message("LANDING_LINKS_BLOCKS_TITLE"));this.showBlocks(i)}return new Promise(function(t){this.promiseResolve=t}.bind(this))},showSites:function(t){var e=t.siteId;void d(this.layout,{width:null});void this.getSites(t).then(function(i){this.appendSidebarButton(new I("current_site",{text:BX.message("LANDING_LINKS_PANEL_CURRENT_SITE")}));i.forEach(function(i){if(parseInt(i.ID)==e){this.appendSidebarButton(new I(i.ID,{text:i.TITLE,onClick:this.onSiteClick.bind(this,i.ID,t.enableAreas),child:true,active:true}))}},this);this.getLandings(e).then(function(e){e.forEach(function(e){if(!e.IS_AREA||e.IS_AREA&&t.enableAreas){this.appendCard(new BX.Landing.UI.Card.LandingPreviewCard({title:e.TITLE,description:e.DESCRIPTION,preview:e.PREVIEW,onClick:this.onLandingClick.bind(this,e.ID,e.TITLE)}))}},this);var i=this.getSystemPages();Object.keys(i).forEach(function(t){var e=i[t];this.appendCard(new BX.Landing.UI.Card.LandingPreviewCard({title:e.name,description:e.description,preview:e.preview,onClick:this.onSystemClick.bind(this,t,e.name)}))},this);this.loader.hide()}.bind(this));if(!t.currentSiteOnly){this.appendSidebarButton(new I("my_sites",{text:BX.message("LANDING_LINKS_PANEL_MY_SITES")}));i.forEach(function(e){this.appendSidebarButton(new I(e.ID,{text:e.TITLE,onClick:this.onSiteClick.bind(this,e.ID,t.enableAreas),child:true}))},this)}}.bind(this))},getSystemPages:function(){var t;try{t=BX.Landing.Main.getInstance().options.syspages;if(!u(t)){t={}}}catch(e){t={}}return t},createCurrentSiteButton:function(){return new I("current_site",{text:BX.message("LANDING_LINKS_PANEL_CURRENT_SITE")})},showBlocks:function(t){var e=t.landingId;var i=t.siteId;void d(this.layout,{width:"880px"});this.getSites(t).then(function(t){this.appendSidebarButton(this.createCurrentSiteButton());var e=t.map(function(t){return t.ID},this);return this.getLandings(e).then(function(e){return t.reduce(function(t,i,n){t[i.ID]={site:i,landings:e[i.ID].result};return t},{})})}.bind(this)).then(function(t){t[i].landings.forEach(function(t){var i=parseInt(t.ID)===parseInt(e);var n=this.createLandingSidebarButton(t,i);this.appendSidebarButton(n);if(i){n.layout.click()}},this);Object.keys(t).forEach(function(e){if(parseInt(e)!==parseInt(i)){var n=t[e].site;this.appendSidebarButton(this.createSiteSidebarButton(n));t[e].landings.forEach(function(t){this.appendSidebarButton(this.createLandingSidebarButton(t))},this)}},this)}.bind(this))},createLandingSidebarButton:function(t,e){return new I(t.ID,{text:t.TITLE,onClick:this.onLandingChange.bind(this,t),child:true,active:e})},createSiteSidebarButton:function(t){return new I(t.ID,{text:t.TITLE,child:false,active:false})},onLandingChange:function(t,e){this.currentSelectedLanding=t;this.sidebarButtons.forEach(function(t){if(t.layout===e.currentTarget){t.activate();return}t.deactivate()});this.showPreviewLoader().then(this.createIframeIfNeed()).then(this.loadPreviewSrc(this.buildLandingPreviewUrl(t))).then(this.hidePreviewLoader())},buildLandingPreviewUrl:function(t){return"/sites/site/"+t.SITE_ID+"/view/"+t.ID+"/?forceLoad=true&landing_mode=edit"},loadPreviewSrc:function(t){return function(){return new Promise(function(e){if(this.previewFrame.src!==t){this.previewFrame.src=t;this.previewFrame.onload=function(){var t=this.previewFrame.contentDocument;BX.Landing.Utils.removePanels(t);[].slice.call(t.querySelectorAll(".block-wrapper")).forEach(function(t){t.classList.add("landing-ui-block-selectable-overlay");t.addEventListener("click",function(e){e.preventDefault();this.onBlockClick(parseInt(t.id.replace("block","")),e)}.bind(this))},this);e(this.previewFrame)}.bind(this);return}e(this.previewFrame)}.bind(this))}.bind(this)},showPreviewLoader:function(){if(!this.loader){this.loader=new BX.Loader}if(this.previewFrameWrapper){void d(this.previewFrameWrapper,{opacity:0})}return new Promise(function(t){void this.loader.show(this.content);t()}.bind(this))},hidePreviewLoader:function(){return function(){void d(this.previewFrameWrapper,{opacity:null});return this.loader.hide()}.bind(this)},createIframeIfNeed:function(){return function(){new Promise(function(t){if(!this.previewFrame){this.previewFrame=o("iframe",{});this.previewFrameWrapper=o("div",{attrs:{style:"width: 100%; height: 100%; overflow: hidden;"}});this.previewFrameWrapper.appendChild(this.previewFrame);this.content.innerHTML="";this.content.appendChild(this.previewFrameWrapper);this.showPreviewLoader();requestAnimationFrame(function(){var t=this.content.clientWidth-40;void d(this.previewFrame,{width:"1000px",height:"calc((100vh - 113px) * (100 / "+t/1e3*100+"))",transform:"scale("+t/1e3+") translateZ(0)","transform-origin":"top left",border:"none"})}.bind(this))}t(this.previewFrame)}.bind(this))}.bind(this)},onBlockClick:function(t,e){if(e.isTrusted){this.getBlocks(this.currentSelectedLanding.ID).then(function(e){var i=e.find(function(e){return e.id===t});if(i){this.onChange({type:v,id:i.id,name:i.name,alias:i.alias})}}.bind(this))}},onLandingClick:function(t,e){this.onChange({type:f,id:t,name:e})},onSystemClick:function(t,e){this.onChange({type:p,id:"_"+t,name:e})},onSiteClick:function(t,e,i){this.sidebarButtons.forEach(function(t){if(t.layout===i.currentTarget){t.activate()}else{t.deactivate()}});this.content.innerHTML="";this.showLoader();this.getLandings(t).then(function(t){t.forEach(function(t){if(!t.IS_AREA||t.IS_AREA&&e){this.appendCard(this.createLandingPreview(t))}},this);this.loader.hide()}.bind(this))},createLandingPreview:function(t){return new BX.Landing.UI.Card.LandingPreviewCard({title:t.TITLE,description:t.DESCRIPTION,preview:t.PREVIEW,onClick:this.onLandingClick.bind(this,t.ID,t.TITLE)})},createBlockPreview:function(t){return new BX.Landing.UI.Card.BlockHTMLPreview({content:t.id,onClick:this.onBlockClick.bind(this,t.id,t.name,t.alias)})},getSites:function(t){if(this.cache.has(t)){return Promise.resolve(this.cache.get(t))}return BX.Landing.Backend.getInstance().action("Site::getList",{params:{order:{ID:"DESC"},filter:t.filter}}).then(function(e){this.cache.add(t,e);return e}.bind(this))},getLandings:function(t,e){t=h(t)||l(t)||g(t)?t:e.siteId;var i=g(t)?t.join(","):t;if(this.cache.has("getLandings"+i)){return Promise.resolve(this.cache.get("getLandings"+i))}if(g(t)){var n=t.reduce(function(t,e){t[e]={action:"Landing::getList",data:{params:{filter:{SITE_ID:e},order:{ID:"DESC"},get_preview:true,check_area:1}}};return t},{});return BX.Landing.Backend.getInstance().batch("Landing::getList",n).then(function(t){this.cache.add("getLandings"+i,t);return t}.bind(this))}return BX.Landing.Backend.getInstance().action("Landing::getList",{params:{filter:{SITE_ID:t},order:{ID:"DESC"},get_preview:true,check_area:1}}).then(function(t){this.cache.add("getLandings"+i,t);return t}.bind(this))},getLanding:function(t,e){if(this.cache.has(["getLanding"+t,e])){return Promise.resolve(this.cache.get(["getLanding"+t,e]))}return BX.Landing.Backend.getInstance().action("Landing::getList",{params:{filter:{ID:t},get_preview:true}}).then(function(i){this.cache.add(["getLanding"+t,e],i);return i}.bind(this))},getBlocks:function(t,e){t=h(t)||l(t)?t:e.landingId;if(this.cache.has(["getBlocks"+t,e])){var i=this.cache.get(["getBlocks"+t,e]);if(i&&typeof i==="object"&&typeof i.then==="function"){return i}return Promise.resolve(i)}var n=BX.Landing.Backend.getInstance().action("Block::getList",{lid:t,params:{get_content:true,edit_mode:true}}).then(function(i){this.cache.set(["getBlocks"+t,e],i);return i}.bind(this));this.cache.set(["getBlocks"+t,e],n);return n},getBlock:function(t){var e="getBlocks"+t;if(this.cache.has(e)){var i=this.cache.get(e);if(i&&typeof i==="object"&&typeof i.then==="function"){return i}return Promise.resolve(i)}var n=BX.Landing.Backend.getInstance().action("Block::getById",{block:t,params:{edit_mode:true}}).then(function(t){this.cache.set(e,t);return t}.bind(this));this.cache.set(e,n);return n},getEntries:function(){return new Promise(function(t){if(this.isNeedLoad){this.getLandings().then(function(e){var i=Promise.all(e.map(function(t){return this.getBlocks(t.ID)},this));i.then(function(i){var n=e.map(function(t,e){var n=i[e];if(u(n)){var a=Object.keys(n);n=a.map(function(t){return i[e][t]})}t.blocks=n;return t});this.lastEntries=n;this.isNeedLoad=false;t(n)}.bind(this))}.bind(this))}else{t(this.lastEntries)}}.bind(this))},onChange:function(t){this.promiseResolve(t);this.hide()},hide:function(){this.previewFrame=null;return BX.Landing.UI.Panel.Content.prototype.hide.call(this)}}})();